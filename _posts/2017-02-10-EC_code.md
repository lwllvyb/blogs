---
title: EC code
date: 2017-03-29 21:44:22
tags: Erasure Code
---

# Erasure Code

## 基本原理

纠删码（EC）是最近段时间啊存储领域比较流行的数据冗余存储方法，类似传统的RAID，但是比RADI方式更灵活

## 详细过程

它将写入的数据分成N份原始数据，通过这个N份原始数据计算出M份校验数据。把N+M份数据分别保存在不同的设备或者节点中，并通过N+M份中的任意N份数据块还原出所有数据块

EC 包含了编码和解码过程：将原始的N份数据计算出M份校验数据称为编码过程；通过N+M份数据中的任意N份数据来还原出原始数据的过程为解码过程。EC 可以容忍M份数据失效，任意小于等于M份的数据失效能通过剩下的数据还原出原始数据。

## 应用

    目前一些主流的云存储厂商都采用EC编码方式。

## RS 编码

* ReedSolomon 编码，简称RS码。
* 缺点
    在N+M份数据中有任意一块数据失效，都需要读取N快数据来恢复丢失数据，在数据恢复的过程中引起的网络开销较大。

## LRC 编码

### LRC 编码的核心思想

将校验块分为全局校验块（global parity）和局部校验块（local reconstruction parity），从而减少网络开销。

### LRC (M, G, L) 的三个参数分别为

* M 是原始数据块的数量

* G 是全局数据块的数量

* L 为局部校验块的数量

### 编码过程

1. 把数据分成 M 个同等大小的数据块， 通过M个数据块计算出 G 份全局校验数据块。
1. 然后把 M个数据块平均分成L 组，每组计算出一个本地数据校验块，这样共有L个局部数据校验块

### 数据恢复开销

* 如果数据块D1 ~ D12只有一个数据块损坏，LRC **只需要读取6个数据块来恢复**。RS 需要读取12个其他的数据块来恢复

* L1、L2 其中一个数据块损坏，LRC 需要读取6个数据块来修复

* G1、G2 其中一个数据损坏，LRC 需要读取12个数据块来修复

### 最大允许失效的数据块

假如 RS 与 LRC 使用相同的数据块和总的校验块数量。
例如：RS （12, 4）, LRC (12, 2, 2)

* RS 允许数据块和校验块中任意的小于等于4个数据的失效

* LRC
  * 数据块D1-D12中，只允许小于等于2个数据块失效
  * 允许所有的校验块（G1, G2, L1, L2）同时失效
  * 允许之多两个数据块和两个本地校验块同时失效

* 综合
  * 失效一个数据块，或者一个本地数据块，LRC 比 RS 恢复数据时，较少一半的磁盘IO和带宽
  * 可靠性有所损失

## SHEC 编码

* 概念

SHEC 编码方式为 SHEC（ K， M， L），其中 K 代表 data chunk 的数量， M 代表 parity chunk 的数量， L 代表计算 parity chunk 时需要的 data chunk 的数量。 其最大允许失效的数据块为： ML/ K。 这样恢复失效 的单个数据块只需要额外读取 L 个数据块。

* 最大损失的数据块

例如：SHEC （10， 6， 5）
最大损失数据块为：M（6） * L(5) / K(10) = 3

* 一个数据块失效

只需读取5个数据块就可以恢复

## EC 与 副本 比较

[EC 与副本](![](http://onjwbz75c.bkt.clouddn.com/17-3-30/19164652-file_1490866635992_2773.png)